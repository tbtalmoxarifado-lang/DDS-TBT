<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTS - Sistema de Presen√ßa Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .print-only { display: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; width: 210mm; padding: 15mm; margin: 0 auto; }
            body { background-color: white !important; }
        }
        
        .attendance-table { width: 100%; border-collapse: collapse; }
        .attendance-table th { background-color: #f8fafc; border: 1px solid #cbd5e1; font-size: 10px; padding: 4px; text-transform: uppercase; }
        .attendance-table td { border: 1px solid #e2e8f0; padding: 4px; height: 28px; font-size: 11px; }

        #signature-pad {
            border: 2px dashed #cbd5e1;
            background-color: #ffffff;
            touch-action: none;
            cursor: crosshair;
        }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <!-- PAINEL DO GERENTE -->
    <div id="adminPanel" class="no-print max-w-5xl mx-auto py-10 px-6 fade-in hidden">
        <header class="mb-10 text-center">
            <h1 class="text-3xl font-black text-slate-800 tracking-tight uppercase">Gest√£o de Presen√ßa NTS</h1>
            <p class="text-slate-500 italic">Preencha os campos para ativar o QR Code</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-black text-slate-400 uppercase mb-2">T√≥pico / Assunto</label>
                            <input type="text" id="inputAssunto" placeholder="Ex: DDS - Seguran√ßa em Altura" class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-400 uppercase mb-2">Respons√°vel</label>
                            <input type="text" id="inputResponsavel" placeholder="Nome do Gestor" class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-400 uppercase mb-2">Data</label>
                            <input type="date" id="inputData" class="w-full px-5 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div class="mt-8 flex gap-4">
                        <button id="btnTV" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-3 opacity-50 cursor-not-allowed" disabled>
                            <span>üì∫</span> MODO PROJE√á√ÉO (TV)
                        </button>
                        <button id="btnPrint" class="bg-slate-800 hover:bg-slate-900 text-white font-bold px-8 py-4 rounded-xl transition-all">
                            IMPRIMIR
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                        <h2 class="font-bold text-slate-800 uppercase text-sm tracking-widest">Participantes (<span id="contador">0</span>)</h2>
                        <button id="btnClear" class="text-xs text-red-500 font-bold hover:underline">LIMPAR TUDO</button>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-[10px] uppercase font-black text-slate-400">
                            <tr>
                                <th class="px-6 py-3">Nome do Colaborador</th>
                                <th class="px-6 py-3">Setor</th>
                                <th class="px-6 py-3 text-right">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="listaAdmin"></tbody>
                    </table>
                    <div id="msgVazia" class="p-10 text-center text-slate-400 text-sm italic">Nenhuma assinatura registrada.</div>
                </div>
            </div>

            <div class="space-y-6">
                <div id="qrContainer" class="bg-slate-200 rounded-2xl p-6 text-slate-500 text-center transition-all duration-500">
                    <p id="qrStatusText" class="text-xs font-black uppercase tracking-widest mb-4 opacity-80">Aguardando dados...</p>
                    <div id="qrcode-preview" class="bg-white p-4 rounded-xl inline-block mb-4 hidden border-4 border-white shadow-lg"></div>
                    <p id="qrHint" class="text-xs font-medium px-4">O QR Code aparecer√° aqui.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODO TV -->
    <div id="tvView" class="hidden no-print fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center p-12 fade-in">
        <button id="btnCloseTV" class="absolute top-10 left-10 text-slate-500 hover:text-white font-bold flex items-center gap-2">
            <span>‚Üê</span> VOLTAR
        </button>
        <div class="text-center mb-10">
            <h2 id="tvAssunto" class="text-6xl font-black text-white uppercase mb-4">--</h2>
            <p class="text-blue-400 text-2xl font-bold uppercase">Gestor: <span id="tvResponsavel" class="text-white">--</span></p>
        </div>
        <div id="qrcode-tv" class="bg-white p-8 rounded-3xl shadow-lg"></div>
        <div class="mt-12 bg-blue-600 text-white px-10 py-4 rounded-full font-black text-2xl animate-pulse">
            ESCANEIE PARA ASSINAR
        </div>
        <p id="tvContador" class="mt-8 text-slate-500 text-xl font-bold uppercase">0 Assinaturas</p>
    </div>

    <!-- P√ÅGINA DO PARTICIPANTE -->
    <div id="participantView" class="hidden fixed inset-0 bg-white z-[200] overflow-y-auto fade-in">
        <div class="max-w-md mx-auto py-10 px-6">
            <div id="formContainer">
                <header class="text-center mb-8 border-b pb-6">
                    <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight">Registro de Presen√ßa</h3>
                    <p id="subAssunto" class="mt-2 text-blue-600 font-bold uppercase text-xs px-4 py-1 bg-blue-50 rounded-full inline-block">--</p>
                </header>
                <form id="formAssinatura" class="space-y-6">
                    <input type="text" id="pNome" required placeholder="Nome Completo" class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-xl font-bold">
                    <input type="text" id="pSetor" required placeholder="Setor" class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-xl font-bold">
                    <div class="text-center">
                        <canvas id="signature-pad" width="400" height="250" class="w-full rounded-2xl shadow-inner border border-slate-200"></canvas>
                        <button type="button" id="btnClearCanvas" class="mt-2 text-[10px] font-black text-slate-400 uppercase">Limpar Assinatura</button>
                    </div>
                    <button type="submit" id="btnSubmitSign" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl uppercase">Confirmar Presen√ßa</button>
                </form>
            </div>
            <div id="msgSucesso" class="hidden text-center py-20 fade-in">
                <div class="text-7xl mb-6">‚úÖ</div>
                <h4 class="text-2xl font-bold">Enviado com Sucesso!</h4>
            </div>
        </div>
    </div>

    <!-- DOC IMPRESS√ÉO -->
    <div id="printDoc" class="print-only">
        <div class="border-b-4 border-slate-900 pb-2 mb-4">
            <h1 class="text-xl font-black uppercase">Lista de Presen√ßa Digital - NTS</h1>
        </div>
        <div class="mb-4 text-xs">
            <p><strong>Assunto:</strong> <span id="printAssunto">--</span></p>
            <p><strong>Respons√°vel:</strong> <span id="printResponsavel">--</span></p>
        </div>
        <table class="attendance-table">
            <thead>
                <tr><th width="30">#</th><th>Colaborador</th><th width="100">Setor</th><th width="150">Assinatura</th></tr>
            </thead>
            <tbody id="printRows"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'nts-presenca-v3';

        let userAuthenticated = false;
        let participantes = [];
        const canvas = document.getElementById('signature-pad');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        const qrPreview = new QRCode(document.getElementById("qrcode-preview"), { width: 160, height: 160 });
        const qrTV = new QRCode(document.getElementById("qrcode-tv"), { width: 400, height: 400 });

        // Fun√ß√µes de UI
        const atualizarQRCodes = () => {
            const assunto = document.getElementById('inputAssunto').value.trim();
            const resp = document.getElementById('inputResponsavel').value.trim();
            if (assunto && resp) {
                const url = window.location.origin + window.location.pathname + "?mode=sign";
                qrPreview.clear(); qrPreview.makeCode(url);
                qrTV.clear(); qrTV.makeCode(url);
                document.getElementById('qrcode-preview').classList.remove('hidden');
                document.getElementById('qrContainer').className = "bg-blue-600 rounded-2xl p-6 text-white text-center shadow-xl";
                document.getElementById('btnTV').disabled = false;
                document.getElementById('btnTV').classList.remove('opacity-50', 'cursor-not-allowed');
                localStorage.setItem('nts_topic', assunto);
            }
        };

        const renderizar = () => {
            document.getElementById('contador').innerText = participantes.length;
            document.getElementById('tvContador').innerText = `${participantes.length} Assinaturas`;
            document.getElementById('msgVazia').style.display = participantes.length ? 'none' : 'block';
            
            document.getElementById('listaAdmin').innerHTML = participantes.map(p => `
                <tr class="border-b border-slate-50">
                    <td class="px-6 py-4 font-bold text-sm">${p.nome}</td>
                    <td class="px-6 py-4 text-xs text-slate-400 uppercase">${p.setor}</td>
                    <td class="px-6 py-4 text-right">
                        <button data-id="${p.id}" class="btn-delete text-red-400 text-[10px] font-black">REMOVER</button>
                    </td>
                </tr>
            `).join('');

            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.onclick = () => removerParticipante(btn.getAttribute('data-id'));
            });

            let rows = "";
            for(let i=0; i<25; i++) {
                const p = participantes[i];
                rows += `<tr><td align="center">${i+1}</td><td>${p ? p.nome : ''}</td><td>${p ? p.setor : ''}</td><td align="center">${p ? `<img src="${p.assinatura}" style="height:15px">` : ''}</td></tr>`;
            }
            document.getElementById('printRows').innerHTML = rows;
        };

        const removerParticipante = async (id) => {
            if (!userAuthenticated) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'participantes', id));
        };

        // Eventos Canvas
        const getPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - rect.left) * (canvas.width / rect.width), y: (clientY - rect.top) * (canvas.height / rect.height) };
        };
        canvas.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); });
        canvas.addEventListener('mousemove', (e) => { if(!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.lineWidth = 3; ctx.stroke(); });
        window.addEventListener('mouseup', () => drawing = false);
        canvas.addEventListener('touchstart', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); });
        canvas.addEventListener('touchmove', (e) => { if(!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.lineWidth = 3; ctx.stroke(); });

        // Auth e Firestore
        const init = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userAuthenticated = true;
                const params = new URLSearchParams(window.location.search);
                if (params.get('mode') === 'sign') {
                    document.getElementById('participantView').classList.remove('hidden');
                    document.getElementById('subAssunto').innerText = localStorage.getItem('nts_topic') || 'Registro';
                } else {
                    document.getElementById('adminPanel').classList.remove('hidden');
                }

                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'participantes'), (snap) => {
                    participantes = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.timestamp - a.timestamp);
                    renderizar();
                });
            }
        });

        // Vincular bot√µes
        document.getElementById('inputAssunto').oninput = (e) => {
            document.getElementById('printAssunto').innerText = e.target.value;
            atualizarQRCodes();
        };
        document.getElementById('inputResponsavel').oninput = (e) => {
            document.getElementById('printResponsavel').innerText = e.target.value;
            atualizarQRCodes();
        };
        document.getElementById('btnTV').onclick = () => {
            document.getElementById('tvAssunto').innerText = document.getElementById('inputAssunto').value;
            document.getElementById('tvResponsavel').innerText = document.getElementById('inputResponsavel').value;
            document.getElementById('tvView').classList.remove('hidden');
        };
        document.getElementById('btnCloseTV').onclick = () => document.getElementById('tvView').classList.add('hidden');
        document.getElementById('btnPrint').onclick = () => window.print();
        document.getElementById('btnClearCanvas').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);
        document.getElementById('btnClear').onclick = async () => {
            if(confirm("Limpar tudo?")) {
                for(const p of participantes) await removerParticipante(p.id);
            }
        };

        document.getElementById('formAssinatura').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmitSign');
            btn.disabled = true; btn.innerText = "ENVIANDO...";
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'participantes'), {
                    nome: document.getElementById('pNome').value.toUpperCase(),
                    setor: document.getElementById('pSetor').value.toUpperCase(),
                    assinatura: canvas.toDataURL(),
                    timestamp: Date.now()
                });
                document.getElementById('formContainer').classList.add('hidden');
                document.getElementById('msgSucesso').classList.remove('hidden');
            } catch (err) {
                btn.disabled = false; btn.innerText = "ERRO - TENTE NOVAMENTE";
            }
        };

        init();
    </script>
</body>
</html>
